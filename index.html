<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024 Road Map</title>
    <!-- Include Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- ... (rest of the HTML remains the same) ... -->

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; // Replace with your Web app URL

        async function fetchTasks() {
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const { tasks, sections } = await response.json();
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '';
                sections.forEach(section => {
                    taskList.innerHTML += `
                        <div class="section-header flex items-center p-2 bg-gray-100">
                            <i class="fas fa-chevron-down mr-2"></i>
                            <h2 class="text-lg font-bold">${section}</h2>
                        </div>
                        <div class="task-buttons mb-2">
                            <button class="add-task-btn px-4 py-2 bg-blue-500 text-white rounded" data-section="${section}">+ Add Task</button>
                            <button class="add-subtask-btn px-4 py-2 bg-green-500 text-white rounded" data-section="${section}">+ Add Subtask</button>
                        </div>
                    `;
                    tasks.filter(task => task.section === section).forEach(task => {
                        const assigneeInitials = task.assignee.split(' ').map(name => name[0]).join('').toUpperCase();
                        taskList.innerHTML += `
                            <div class="task-item flex items-center p-2 border-b" data-task-id="${task.id}" data-parent-task="${task.parentTask || ''}">
                                <input type="checkbox" class="mr-2">
                                <span class="flex-grow">${task.parentTask || task.subtask}</span>
                                <div class="assignee-avatar bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center mr-2">${assigneeInitials}</div>
                                <span class="text-sm text-gray-500 mr-2">${task.dueDate}</span>
                                <select class="status-select p-1 rounded border">
                                    <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                    <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                        `;
                    });
                });

                // Add event listeners for status changes
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const taskItem = e.target.closest('.task-item');
                        const taskId = taskItem.getAttribute('data-task-id');
                        const status = e.target.value;
                        await updateTaskStatus(taskId, status);
                    });
                });

                // Add event listeners for task and subtask buttons
                document.querySelectorAll('.add-task-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const section = e.target.getAttribute('data-section');
                        document.getElementById('section').value = section;
                        document.getElementById('addTaskModal').classList.remove('hidden');
                    });
                });

                document.querySelectorAll('.add-subtask-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const section = e.target.getAttribute('data-section');
                        const parentTasks = tasks.filter(task => task.section === section && task.type === "Task").map(task => `<option value="${task.id}">${task.parentTask}</option>`).join('');
                        document.getElementById('parentTaskSelect').innerHTML = parentTasks;
                        document.getElementById('addSubtaskModal').classList.remove('hidden');
                    });
                });
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
        }

        async function updateTaskStatus(taskId, status) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'updateTaskStatus', taskId, status }),
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                fetchTasks(); // Refresh task list after updating status
            } catch (error) {
                console.error('Error updating task status:', error);
            }
        }

        async function addTask(parentTask, section, assignee, startDate, dueDate, status) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'addTask', parentTask, section, assignee, startDate, dueDate, status }),
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                document.getElementById('addTaskModal').classList.add('hidden');
                fetchTasks(); // Refresh task list after adding task
            } catch (error) {
                console.error('Error adding task:', error);
            }
        }

        async function addSubtask(parentTask, subtask, section, assignee, startDate, dueDate, status) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'addSubtask', parentTask, subtask, section, assignee, startDate, dueDate, status }),
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                document.getElementById('addSubtaskModal').classList.add('hidden');
                fetchTasks(); // Refresh task list after adding subtask
            } catch (error) {
                console.error('Error adding subtask:', error);
            }
        }

        async function addSection(sectionName) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'addSection', sectionName }),
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                document.getElementById('addSectionModal').classList.add('hidden');
                fetchTasks(); // Refresh task list after adding section
            } catch (error) {
                console.error('Error adding section:', error);
            }
        }

        document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentTask = document.getElementById('parentTask').value;
            const section = document.getElementById('section').value;
            const assignee = document.getElementById('assignee').value;
            const startDate = document.getElementById('startDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const status = document.getElementById('status').value;
            await addTask(parentTask, section, assignee, startDate, dueDate, status);
        });

        document.getElementById('addSubtaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const parentTask = document.getElementById('parentTaskSelect').value;
            const subtask = document.getElementById('subtaskName').value;
            const section = document.getElementById('subtaskSection').value;
            const assignee = document.getElementById('subtaskAssignee').value;
            const startDate = document.getElementById('subtaskStartDate').value;
            const dueDate = document.getElementById('subtaskDueDate').value;
            const status = document.getElementById('subtaskStatus').value;
            await addSubtask(parentTask, subtask, section, assignee, startDate, dueDate, status);
        });

        document.getElementById('addSectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sectionName = document.getElementById('sectionName').value;
            await addSection(sectionName);
        });

        document.getElementById('addSectionBtn').addEventListener('click', () => {
            document.getElementById('addSectionModal').classList.remove('hidden');
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('addTaskModal').classList.add('hidden');
        });

        document.getElementById('cancelSubtaskBtn').addEventListener('click', () => {
            document.getElementById('addSubtaskModal').classList.add('hidden');
        });

        document.getElementById('cancelSectionBtn').addEventListener('click', () => {
            document.getElementById('addSectionModal').classList.add('hidden');
        });

        fetchTasks(); // Fetch tasks initially on page load
    </script>
</body>
</html>
